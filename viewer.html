<html>
  <head>
    <title>Game of Life Viewer</title>
    <link href="https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css" rel="stylesheet">
  </head>
  <body class="bg-gray-100">
    <div class="z-10 absolute w-96 opacity-75 left-4 rotate-90" style="transform: rotate(-90deg); transform-origin: top left; bottom:-20px;">
      <a href="https://gaincompliance.com/careers" target="_blank" title="View our job postings and come work with us!">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 921 87"><g fill="none" fill-rule="evenodd"><g fill-rule="nonzero"><path d="M134.5 49.7v-6.4H152c0 16.6-9.6 22-18.8 22-12 0-21.8-8.8-21.8-20 0-12 9-20.7 21-20.7 9.6 0 14.8 4.8 15.1 5.1l-3.6 5.5c-.2-.3-4.3-4-11.4-4-8.1 0-13.3 6-13.3 14 0 7.1 5.7 13.6 14 13.6 6 0 10.7-4 11-9.1h-9.7ZM176 38.8l-5.8 12.4H182l-6-12.4Zm12.3 25.7-3.4-7.2h-17.7l-3.4 7.2h-8L176 23.8l20.4 40.7h-8.2Zm15.7-39h7.3v39H204zm26.9 15.2v23.8h-7.2v-40l28.7 25.8V25.5h7.3l-.1 40.4z" fill="#0D72B9"/><path d="M306.9 60.3a19 19 0 0 1-13.2 4.9A20.2 20.2 0 0 1 273.1 45a20 20 0 0 1 20.5-20.2c5.7 0 10.3 2.4 13.2 5l-2.1 2.7c-2.3-2.4-6-4.3-11.5-4.3-9.2 0-16.2 7-16.2 17 0 9.4 7.6 16.7 16.8 16.7 5 0 9-1.8 11.3-4l1.8 2.4Zm28.3-32.1c-9.4 0-16.9 7-16.9 16.6 0 9 7.3 17 16.5 17 9.6 0 17-7.2 17-16.7 0-9.8-7.5-17-16.6-17m0 37.1c-11.6 0-20.8-9-20.8-20.2s9.2-20.2 20.8-20.2a20 20 0 0 1 20.5 20.4c0 11-9.4 20-20.5 20m69.9-.7-2.5-27v-1.6l-.7 1.3L387.4 66l-14.6-28.7-.7-1.4v1.7l-2.5 27h-3.9l4.3-40 16.6 31.7c.2.3.7 1.4.8 2 .1-.6.6-1.7.7-2l16.6-31.8 4.3 40h-4Zm23.5-18.7c6.8 0 11-3.3 11-9 0-5.3-4.3-8-9.4-8h-5v17h3.4Zm-7 18.7v-39h7.7c7 0 14 2.8 14 11.3 0 7-4.6 12.3-14.6 12.3h-3.4v15.4h-3.7Zm32.9-.1V25.5h3.7v35.6h16.6v3.3zm30.6-38.9h3.7v39h-3.7zm31.7 9.2-.9-2.4-1 2.4-7 16h16l-7-16ZM530 64.5 525.4 54h-19l-4.6 10.4h-4L516 24.3l18 40.2h-4ZM546.7 34v30.5H543v-40l29.9 31.8V25.5h3.7l-.1 40.3zm75.5 26.3a19 19 0 0 1-13.2 4.9A20.2 20.2 0 0 1 588.4 45a20 20 0 0 1 20.5-20.2c5.7 0 10.3 2.4 13.2 5l-2.1 2.7c-2.3-2.4-6-4.3-11.5-4.3-9.2 0-16.2 7-16.2 17 0 9.4 7.6 16.7 16.8 16.7 5 0 9-1.8 11.3-4l1.8 2.4Zm11.4 4.1V25.5h20.2v3.3h-16.5V42h13.3v3.4h-13.3v15.8h18.2v3.3z" fill="#00A5E1"/><path d="M75.9 34.2a34.1 34.1 0 0 1-33 43.5 34.3 34.3 0 1 1 16.9-64l4.9-7.1a43 43 0 1 0 17.2 19l-6 8.6Z" fill="#0D72B9"/><path d="m81.1 13 9-13H79l-4.2 6c2.2 2.2 4.4 4.5 6.4 7m-18.3 9.8L42.4 52.1 23.5 24.8v16.4l18.9 27.2L69 30.3a81 81 0 0 0-6.1-7.5" fill="#00A5E1"/><path d="m71 11.2-5 7a34 34 0 0 1 6.2 7.5l5.3-7.5c-2-2.6-4-5-6.5-7" fill="#F05B26"/><path d="M134.5 49.7v-6.4H152c0 16.6-9.6 22-18.8 22-12 0-21.8-8.8-21.8-20 0-12 9-20.7 21-20.7 9.6 0 14.8 4.8 15.1 5.1l-3.6 5.5c-.2-.3-4.3-4-11.4-4-8.1 0-13.3 6-13.3 14 0 7.1 5.7 13.6 14 13.6 6 0 10.7-4 11-9.1h-9.7ZM176 38.8l-5.8 12.4H182l-6-12.4Zm12.3 25.7-3.4-7.2h-17.7l-3.4 7.2h-8L176 23.8l20.4 40.7h-8.2Zm15.7-39h7.3v39H204zm26.9 15.2v23.8h-7.2v-40l28.7 25.8V25.5h7.3l-.1 40.4z" fill="#0D72B9"/><path d="M306.9 60.3a19 19 0 0 1-13.2 4.9A20.2 20.2 0 0 1 273.1 45a20 20 0 0 1 20.5-20.2c5.7 0 10.3 2.4 13.2 5l-2.1 2.7c-2.3-2.4-6-4.3-11.5-4.3-9.2 0-16.2 7-16.2 17 0 9.4 7.6 16.7 16.8 16.7 5 0 9-1.8 11.3-4l1.8 2.4Zm28.3-32.1c-9.4 0-16.9 7-16.9 16.6 0 9 7.3 17 16.5 17 9.6 0 17-7.2 17-16.7 0-9.8-7.5-17-16.6-17m0 37.1c-11.6 0-20.8-9-20.8-20.2s9.2-20.2 20.8-20.2a20 20 0 0 1 20.5 20.4c0 11-9.4 20-20.5 20m69.9-.7-2.5-27v-1.6l-.7 1.3L387.4 66l-14.6-28.7-.7-1.4v1.7l-2.5 27h-3.9l4.3-40 16.6 31.7c.2.3.7 1.4.8 2 .1-.6.6-1.7.7-2l16.6-31.8 4.3 40h-4Zm23.5-18.7c6.8 0 11-3.3 11-9 0-5.3-4.3-8-9.4-8h-5v17h3.4Zm-7 18.7v-39h7.7c7 0 14 2.8 14 11.3 0 7-4.6 12.3-14.6 12.3h-3.4v15.4h-3.7Zm32.9-.1V25.5h3.7v35.6h16.6v3.3zm30.6-38.9h3.7v39h-3.7zm31.7 9.2-.9-2.4-1 2.4-7 16h16l-7-16ZM530 64.5 525.4 54h-19l-4.6 10.4h-4L516 24.3l18 40.2h-4ZM546.7 34v30.5H543v-40l29.9 31.8V25.5h3.7l-.1 40.3zm75.5 26.3a19 19 0 0 1-13.2 4.9A20.2 20.2 0 0 1 588.4 45a20 20 0 0 1 20.5-20.2c5.7 0 10.3 2.4 13.2 5l-2.1 2.7c-2.3-2.4-6-4.3-11.5-4.3-9.2 0-16.2 7-16.2 17 0 9.4 7.6 16.7 16.8 16.7 5 0 9-1.8 11.3-4l1.8 2.4Zm11.4 4.1V25.5h20.2v3.3h-16.5V42h13.3v3.4h-13.3v15.8h18.2v3.3z" fill="#00A5E1"/></g><path d="M706.1 45.3v-2h-9.7v-8h11.2v-2H694V56h13.7v-2h-11.3v-8.7zM729 56V33.2h-2.4v18.1l-9.6-18h-2.4V56h2.4V38l9.6 18zm21.7-2.8v-8.3h-7.3v2h5v5.6l-1 .9-1.2.5-1.4.3h-1.3A5 5 0 0 1 740 53a6 6 0 0 1-1.1-1.4 9.9 9.9 0 0 1-1.2-3.6l-.2-1.9v-3a13 13 0 0 1 1.2-5.3l1.1-1.4a4.8 4.8 0 0 1 3.4-1.3c.7 0 1.4.1 2 .4a4.7 4.7 0 0 1 2.5 2.5c.3.6.5 1.2.6 1.9h2.4c-.1-1-.4-2-.8-2.8a7 7 0 0 0-6.7-4 7.3 7.3 0 0 0-4.6 1.5c-.6.5-1.1 1-1.5 1.7a12.5 12.5 0 0 0-2 7V46a14.4 14.4 0 0 0 1 5l1.1 2a7.2 7.2 0 0 0 6.2 3.3 10.1 10.1 0 0 0 4.7-1.1 8.6 8.6 0 0 0 2.6-2Zm6.8-20v2.1h5.4V54h-5.4v2h13.4v-2h-5.5V35.2h5.5v-2zM792.6 56V33.2h-2.3l-.1 18.1-9.6-18h-2.4V56h2.4V38l9.7 18zm19.6-10.7v-2h-9.8v-8h11.2v-2H800V56h13.7v-2h-11.3v-8.7zm21.2 0v-2h-9.8v-8h11.2v-2h-13.6V56h13.7v-2h-11.3v-8.7zm16.5 1.3 4.7 9.4h2.5v-.2l-5-9.7a9 9 0 0 0 1.8-1 6.4 6.4 0 0 0 2.3-3c.2-.6.3-1.3.3-2 0-1.2-.2-2.2-.6-3a6 6 0 0 0-1.6-2.1 7 7 0 0 0-2.4-1.3c-1-.3-1.9-.4-3-.5h-6.5V56h2.4v-9.4h5Zm-5.1-2v-9.4h4.2a7 7 0 0 1 2 .4 4.3 4.3 0 0 1 2.7 2.4c.3.6.4 1.2.4 2a4 4 0 0 1-.4 1.9c-.2.6-.6 1-1 1.4l-1.6 1c-.6.2-1.2.3-1.9.3h-4.4Zm18.7-11.4v2.1h5.4V54h-5.4v2H877v-2h-5.6V35.2h5.6v-2zM898.7 56V33.2h-2.4l-.1 18.1-9.6-18h-2.4V56h2.4V38l9.7 18zm21.6-2.8v-8.3H913v2h5v5.6l-1 .9-1.2.5-1.4.3h-1.3a5 5 0 0 1-3.5-1.3 6 6 0 0 1-1-1.4 9.9 9.9 0 0 1-1.3-3.6L907 46v-3a13 13 0 0 1 1.3-5.3l1-1.4a4.8 4.8 0 0 1 3.4-1.3c.7 0 1.4.1 2 .4a4.7 4.7 0 0 1 2.5 2.5c.3.6.5 1.2.6 1.9h2.4c-.1-1-.4-2-.8-2.8a7 7 0 0 0-6.7-4 7.3 7.3 0 0 0-4.6 1.5c-.6.5-1 1-1.5 1.7-.5.6-.8 1.3-1 2.1a12.5 12.5 0 0 0-1 4.8v3a14.4 14.4 0 0 0 1 4.8c.3.8.7 1.5 1.1 2.1a7.2 7.2 0 0 0 6.2 3.3 10.1 10.1 0 0 0 4.8-1.1 8.6 8.6 0 0 0 2.5-2Z" fill="#F05B26" fill-rule="nonzero"/><path stroke="#F05B26" stroke-width="1.5" opacity=".5" stroke-linecap="square" d="m689.5 13.5-22 62"/></g></svg>
      </a>
    </div>
    <div class="grid place-items-center h-screen">
      <div class="z-20 shadow-xl bg-white rounded ">
        <div class="text-gray-500 flex justify-around border-b py-3">
          <p>ID: <span id="id"></span></p>
          <p>Generation: <span class="w-8 text-right inline-block" id="currentGeneration">0</span> of <span id="generationCount"></span></p>
        </div>
        <div id="loading" class="fixed" style="width:600px; margin-top:250px">
          <div class="text-center text-3xl text-gray-600"><span class="text-5xl block animate-spin mb-4">ðŸ§¬</span>loading life</div>
        </div>
        <canvas class="m-2" id="world" width="600" height="600"></canvas>
        <div class="flex pt-2 pb-2 border-t">
          <input id="scrubber" class="w-5/6 m-auto" type="range" value=1 min=1, max=100 />
        </div>
        <div class=" flex justify-around border-t">
          <button id="back" class="rounded p-2 m-2 shadow hover:bg-blue-100 hover:text-blue-500">&larr; Back</button>
          <button id="run" class="rounded p-2 px-4 m-2 shadow hover:bg-blue-100 hover:text-blue-500">Run &triangleright;</button>
          <button id="next" class="rounded p-2 m-2 shadow hover:bg-blue-100 hover:text-blue-500">Next &rarr;</button>
        </div>
      </div>
    </div>
  </body>
  <script>
    const worldElement = document.getElementById('world');
    const worldCanvas = worldElement.getContext('2d');
    const worldWidth = worldElement.clientWidth;
    const scrubberElement = document.getElementById('scrubber');
    const currentGenerationElement = document.getElementById('currentGeneration');
    const generationCountElement = document.getElementById('generationCount');
    const idLabelElement = document.getElementById('id');
    const backButton = document.getElementById('back');
    const nextButton = document.getElementById('next');
    const runButton = document.getElementById('run');

    const LEFT_ARROW = 37;
    const RIGHT_ARROW = 39;
    const SPACE_BAR = 32;

    const hideLoadingMessage = () => {
      document.getElementById('loading').style.display = 'none';
    }

    const updateLoadingMessage = (message) => {
      const messageElement = document.getElementById('loading');
      messageElement.style.display = 'fixed';
      messageElement.querySelector('div').innerHTML = message;
    }

    const setUpWorld = ({generationCount, id, generations}) => {
      hideLoadingMessage();
      idLabelElement.innerText = id;
      generationCountElement.innerText = generationCount;
      scrubberElement.max = generationCount;
      var size = generations[0][0].length;
      const cellSize = (worldWidth/size) - 1;
      let currentGeneration = 1;

      const drawGeneration = (generation) => {
        worldCanvas.fillStyle = 'white';
        worldCanvas.fillRect(0, 0, worldWidth, worldWidth);
        currentGenerationElement.innerHTML = generation;
        scrubberElement.value = generation
        const world = generations[generation - 1];
        for(let row = 0; row < world.length; row++) {
          for(let column = 0; column < world[row].length; column++) {
            const life = world[row][column];
            worldCanvas.fillStyle = life ? 'lightblue' : 'white';
            const [x,y] = [row * (cellSize+1), column * (cellSize+1)];
            worldCanvas.fillRect(x, y, cellSize, cellSize);
          }
        }
      }
      drawGeneration(currentGeneration);

      setGeneration = (gen) => {
        currentGeneration = Math.min(Math.max(1, gen), generationCount);
        drawGeneration(currentGeneration);
      }
      let isPlaying = false;

      const gotoPreviousGeneration = () => {isPlaying = false; setGeneration(currentGeneration-1)}
      const gotoNextGeneration = () => {isPlaying = false; setGeneration(currentGeneration+1)}
      const play = () => {
        isPlaying = !isPlaying;
        let intervalId = setInterval(() => {
          if(isPlaying && currentGeneration <= generationCount) {
            setGeneration(currentGeneration+1);
          } else {
            clearInterval(intervalId);
          }
        }, 64);
      }

      backButton.addEventListener('click', gotoPreviousGeneration)
      nextButton.addEventListener('click', gotoNextGeneration)
      runButton.addEventListener('click', play);

      document.addEventListener('keydown', e => {
        if(e.keyCode == SPACE_BAR) play();
        if(e.keyCode == LEFT_ARROW) gotoPreviousGeneration();
        if(e.keyCode == RIGHT_ARROW) gotoNextGeneration();
      })
      scrubberElement.addEventListener('input', () => {setGeneration(scrubberElement.value)});
    }

    const NANO_ID_AS_LAST_PATH_PART_PATTERN = /\/([A-Za-z0-9_-]+)$/
    if(!NANO_ID_AS_LAST_PATH_PART_PATTERN.test(window.location.pathname)){
      updateLoadingMessage(`Unable to find a correct results ID in the URL, it should be formatted like "viewer/LWGtYCEy-N24px5OLaZl5rvE4VqpX_"`);
    }

    const idMatches = window.location.pathname.match(NANO_ID_AS_LAST_PATH_PART_PATTERN)
    if(idMatches){
      const [_, id] = idMatches;
      fetch(`/results/${id}`).then(response => {
        if(response.ok){
          response.json().then(data => setUpWorld(data))
        } else {
          response.text().then(updateLoadingMessage);
          console.log('hi there, I bet you are wondering what is going wrong, likely you didn\'t follow the 302 redirect url', response)
        }
      }).catch(error => {
        updateLoadingMessage(`Oh no, we couldn't load your result, see the console for more information`)
        console.error(error)
      });
    } else {
      const pathParts = window.location.pathname.split('/')
      const possibleId = pathParts[pathParts.length - 1];
      updateLoadingMessage(`hmmm, couldn't parse that ID, you sure it's correct? <br /><br />The id "${possibleId}" doesn't match the expected pattern.`)
    }
  </script>
</html>
